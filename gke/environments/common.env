# RustMQ GKE Deployment - Common Configuration
# Phase 2: Configuration Management (October 2025)
#
# This file contains shared defaults for all environments.
# Values can be overridden in dev.env, staging.env, or prod.env.
#
# Configuration Priority: prod.env > staging.env > dev.env > common.env > Defaults

# ============================================================
# GCP Infrastructure
# ============================================================

# GCP Project (REQUIRED - must be overridden in environment files)
GCP_PROJECT_ID="${GCP_PROJECT_ID:-}"

# GCP Region and Zone
GCP_REGION="us-central1"
GCP_ZONE="us-central1-a"

# ============================================================
# Docker Registry
# ============================================================

# Container registry for RustMQ images
DOCKER_REGISTRY="gcr.io/${GCP_PROJECT_ID}"

# Image tag (default to latest, override with version in prod)
IMAGE_TAG="latest"

# Multi-platform support (AMD64 and ARM64 from Phase 1)
BUILD_PLATFORMS="linux/amd64,linux/arm64"

# ============================================================
# GKE Cluster Configuration
# ============================================================

# Cluster name (REQUIRED - must be overridden)
CLUSTER_NAME="${CLUSTER_NAME:-rustmq-cluster}"

# GKE version (use stable channel)
GKE_VERSION="latest"

# Enable GKE features
ENABLE_WORKLOAD_IDENTITY="true"
ENABLE_NETWORK_POLICY="true"
ENABLE_POD_SECURITY_POLICY="false"  # Deprecated, use Pod Security Standards
ENABLE_BINARY_AUTHORIZATION="false"  # Enable in production

# Node pool configuration
DEFAULT_NODE_POOL_NAME="default-pool"
DEFAULT_NODE_MACHINE_TYPE="n2-standard-4"
DEFAULT_NODE_DISK_SIZE="100"  # GB
DEFAULT_NODE_DISK_TYPE="pd-standard"

# ============================================================
# RustMQ Controller Configuration
# ============================================================

# Controller replicas (MUST be odd for Raft quorum: 1, 3, 5, 7)
CONTROLLER_REPLICAS="3"

# Controller resource requests and limits
CONTROLLER_CPU_REQUEST="1000m"
CONTROLLER_CPU_LIMIT="2000m"
CONTROLLER_MEMORY_REQUEST="2Gi"
CONTROLLER_MEMORY_LIMIT="4Gi"

# Controller ports
CONTROLLER_RPC_PORT="9094"
CONTROLLER_RAFT_PORT="9095"
CONTROLLER_HTTP_PORT="9642"

# Controller Raft configuration
CONTROLLER_RAFT_SNAPSHOT_INTERVAL="10000"
CONTROLLER_RAFT_LOG_COMPACTION_THRESHOLD="1000"
CONTROLLER_RAFT_HEARTBEAT_INTERVAL="1000"  # ms
CONTROLLER_RAFT_HEARTBEAT_TIMEOUT="2000"   # ms (must be > interval)
CONTROLLER_RAFT_ELECTION_TIMEOUT="5000"    # ms

# ============================================================
# RustMQ Broker Configuration
# ============================================================

# Broker autoscaling
BROKER_MIN_NODES="2"
BROKER_MAX_NODES="10"

# Broker resource requests and limits
BROKER_CPU_REQUEST="2000m"
BROKER_CPU_LIMIT="4000m"
BROKER_MEMORY_REQUEST="4Gi"
BROKER_MEMORY_LIMIT="8Gi"

# Broker ports
BROKER_QUIC_PORT="9092"
BROKER_RPC_PORT="9093"
BROKER_HEALTH_PORT="9642"
BROKER_ETL_PORT="9096"

# Broker storage configuration
BROKER_WAL_SIZE="100Gi"
BROKER_WAL_STORAGE_CLASS="fast-ssd"  # Use local SSD in GKE
BROKER_ENABLE_LOCAL_SSD="true"

# Broker connection limits
BROKER_MAX_CONNECTIONS="10000"
BROKER_CONNECTION_TIMEOUT_MS="30000"

# ============================================================
# Object Storage (GCS) Configuration
# ============================================================

# GCS bucket for message storage (REQUIRED - must be set per environment)
GCS_BUCKET="${GCS_BUCKET:-}"
GCS_REGION="${GCP_REGION}"

# Object storage settings
OBJECT_STORAGE_TYPE="GCS"
OBJECT_STORAGE_MULTIPART_THRESHOLD="104857600"  # 100MB
OBJECT_STORAGE_MAX_CONCURRENT_UPLOADS="10"

# ============================================================
# Cache Configuration
# ============================================================

# Moka cache (enabled by default from Phase 1 optimizations)
ENABLE_MOKA_CACHE="true"

# Cache sizes
WRITE_CACHE_SIZE_BYTES="1073741824"   # 1GB
READ_CACHE_SIZE_BYTES="2147483648"    # 2GB
L2_CACHE_SHARD_COUNT="64"             # CPU-adaptive from Phase 1

# ============================================================
# Replication Configuration
# ============================================================

REPLICATION_MIN_IN_SYNC_REPLICAS="2"
REPLICATION_ACK_TIMEOUT_MS="5000"
REPLICATION_MAX_LAG="1000"

# ============================================================
# ETL/WASM Configuration
# ============================================================

ETL_ENABLED="true"
ETL_MEMORY_LIMIT_BYTES="67108864"     # 64MB
ETL_EXECUTION_TIMEOUT_MS="5000"
ETL_MAX_CONCURRENT_EXECUTIONS="100"

# ============================================================
# Security Configuration
# ============================================================

# TLS/mTLS
TLS_ENABLED="true"
MTLS_ENABLED="true"

# Secrets in Google Secret Manager (references only, not actual secrets)
TLS_CERT_SECRET_NAME="rustmq-tls-cert"
TLS_KEY_SECRET_NAME="rustmq-tls-key"
TLS_CA_SECRET_NAME="rustmq-ca-cert"
GCS_CREDENTIALS_SECRET_NAME="rustmq-gcs-credentials"

# ACL (fast 547ns lookups from Phase 1)
ENABLE_ACL="true"
ACL_CACHE_SIZE="10000"

# ============================================================
# Monitoring & Observability
# ============================================================

# Enable monitoring
ENABLE_MONITORING="true"
ENABLE_PROMETHEUS="true"
ENABLE_GRAFANA="true"

# Enable logging
ENABLE_LOGGING="true"
LOG_LEVEL="info"
LOG_FORMAT="json"

# Enable tracing
ENABLE_TRACING="false"  # Enable in staging/prod

# Metrics collection interval
METRICS_INTERVAL_SECONDS="60"

# ============================================================
# Networking Configuration
# ============================================================

# VPC configuration
VPC_NAME="rustmq-vpc"
SUBNET_NAME="rustmq-subnet"
SUBNET_CIDR="10.0.0.0/20"

# Load Balancer
ENABLE_LOAD_BALANCER="true"
LOAD_BALANCER_TYPE="INTERNAL"  # INTERNAL or EXTERNAL

# Network policies
ENABLE_NETWORK_POLICIES="true"

# ============================================================
# High Availability Configuration
# ============================================================

# Pod disruption budgets
ENABLE_PDB="true"
CONTROLLER_MIN_AVAILABLE="2"  # For 3 replicas
BROKER_MIN_AVAILABLE="1"      # For N replicas

# Pod anti-affinity (spread across nodes/zones)
ENABLE_POD_ANTI_AFFINITY="true"
ENABLE_ZONE_ANTI_AFFINITY="true"

# ============================================================
# Scaling Configuration
# ============================================================

# Horizontal Pod Autoscaler (HPA)
ENABLE_HPA="true"
BROKER_HPA_TARGET_CPU="70"     # Target CPU utilization %
BROKER_HPA_TARGET_MEMORY="80"  # Target memory utilization %

# Cluster Autoscaler
ENABLE_CLUSTER_AUTOSCALER="true"

# Scaling behavior
MAX_CONCURRENT_BROKER_ADDITIONS="3"
MAX_CONCURRENT_BROKER_DECOMMISSIONS="2"
REBALANCE_TIMEOUT_MS="300000"  # 5 minutes

# ============================================================
# Operations Configuration
# ============================================================

# Allow runtime config updates
ALLOW_RUNTIME_CONFIG_UPDATES="true"

# Graceful shutdown timeout
GRACEFUL_SHUTDOWN_TIMEOUT_MS="30000"

# Health check configuration
HEALTH_CHECK_TIMEOUT_MS="10000"
HEALTH_CHECK_INTERVAL_SECONDS="30"

# ============================================================
# Cost Optimization
# ============================================================

# Auto-shutdown for non-production (override in dev/staging)
ENABLE_AUTO_SHUTDOWN="false"
AUTO_SHUTDOWN_SCHEDULE="0 22 * * 1-5"  # 10pm weekdays
AUTO_STARTUP_SCHEDULE="0 6 * * 1-5"    # 6am weekdays

# Preemptible nodes (use in dev/staging, not prod)
ENABLE_PREEMPTIBLE_NODES="false"
PREEMPTIBLE_NODE_PERCENTAGE="0"

# ============================================================
# Admin Configuration
# ============================================================

# Admin server
ADMIN_SERVER_REPLICAS="1"
ADMIN_SERVER_PORT="8080"
ADMIN_SERVER_CPU="500m"
ADMIN_SERVER_MEMORY="1Gi"

# ============================================================
# Feature Flags
# ============================================================

# Enable experimental features
ENABLE_EXPERIMENTAL_FEATURES="false"

# Enable debug mode
ENABLE_DEBUG_MODE="false"

# ============================================================
# Validation Settings
# ============================================================

# Skip validation (use with caution!)
SKIP_VALIDATION="false"

# Dry run mode (show what would be done without doing it)
DRY_RUN="false"

# Verbose logging
VERBOSE="false"
