# RustMQ GKE Deployment - Production Environment
# Phase 2: Configuration Management (October 2025)
#
# Production environment optimized for:
# - Maximum reliability and high availability
# - Enterprise-grade security
# - Production-scale performance
# - 24/7 operation
#
# Inherits from: common.env
# Override priority: prod.env > common.env (HIGHEST PRIORITY)

# ============================================================
# GCP Infrastructure - Production
# ============================================================

# GCP Project (SET THIS!)
GCP_PROJECT_ID="rustmq-production"

# Multi-zone multi-region for maximum HA
GCP_REGION="us-central1"
GCP_ZONE="us-central1-a"  # Primary zone
GCP_ZONES="us-central1-a,us-central1-b,us-central1-c"  # All zones
GCP_SECONDARY_REGION="us-east1"  # Disaster recovery region

# ============================================================
# GKE Cluster - Production
# ============================================================

CLUSTER_NAME="rustmq-production"

# Production-grade machine types
DEFAULT_NODE_MACHINE_TYPE="n2-standard-8"  # 8 vCPU, 32GB RAM
DEFAULT_NODE_DISK_SIZE="200"  # 200GB SSD
DEFAULT_NODE_DISK_TYPE="pd-ssd"  # SSD for performance

# Production node pools
MIN_NODES="5"   # Always maintain minimum for HA
MAX_NODES="100"  # Scale up to 100 for high load

# Enable ALL production features
ENABLE_BINARY_AUTHORIZATION="true"  # REQUIRED for prod
ENABLE_WORKLOAD_IDENTITY="true"     # REQUIRED for prod
ENABLE_NETWORK_POLICY="true"        # REQUIRED for prod

# GKE release channel (use STABLE for production)
GKE_RELEASE_CHANNEL="STABLE"

# ============================================================
# RustMQ Controller - Production
# ============================================================

# 5 controllers for Raft quorum (N=5 tolerates 2 failures)
# MUST be odd number: 1, 3, 5, 7
CONTROLLER_REPLICAS="5"

# Production resources (high-performance)
CONTROLLER_CPU_REQUEST="2000m"
CONTROLLER_CPU_LIMIT="4000m"
CONTROLLER_MEMORY_REQUEST="4Gi"
CONTROLLER_MEMORY_LIMIT="8Gi"

# Production Raft settings (tuned for reliability)
CONTROLLER_RAFT_SNAPSHOT_INTERVAL="10000"
CONTROLLER_RAFT_LOG_COMPACTION_THRESHOLD="1000"
CONTROLLER_RAFT_HEARTBEAT_INTERVAL="1000"
CONTROLLER_RAFT_HEARTBEAT_TIMEOUT="2000"
CONTROLLER_RAFT_ELECTION_TIMEOUT="5000"

# ============================================================
# RustMQ Broker - Production
# ============================================================

# Production-scale broker autoscaling
BROKER_MIN_NODES="5"   # Always maintain minimum for HA
BROKER_MAX_NODES="50"  # Scale to 50 brokers under load

# Production resources (high-performance)
BROKER_CPU_REQUEST="4000m"
BROKER_CPU_LIMIT="8000m"
BROKER_MEMORY_REQUEST="8Gi"
BROKER_MEMORY_LIMIT="16Gi"

# Production WAL with local SSD (critical for performance)
BROKER_WAL_SIZE="100Gi"
BROKER_ENABLE_LOCAL_SSD="true"  # REQUIRED for prod performance
BROKER_WAL_STORAGE_CLASS="fast-ssd"

# Production connection limits
BROKER_MAX_CONNECTIONS="10000"  # High concurrency
BROKER_CONNECTION_TIMEOUT_MS="30000"

# ============================================================
# Object Storage - Production
# ============================================================

# Production GCS bucket (highly available, multi-region)
GCS_BUCKET="rustmq-production-storage"
GCS_STORAGE_CLASS="STANDARD"  # or MULTI_REGIONAL for HA
GCS_LIFECYCLE_POLICY="enabled"  # Archive old data

# Production object storage settings
OBJECT_STORAGE_TYPE="GCS"
OBJECT_STORAGE_MULTIPART_THRESHOLD="104857600"  # 100MB
OBJECT_STORAGE_MAX_CONCURRENT_UPLOADS="20"  # Higher concurrency

# ============================================================
# Cache - Production
# ============================================================

# Production caches (from Phase 1 moka optimization)
WRITE_CACHE_SIZE_BYTES="1073741824"   # 1GB
READ_CACHE_SIZE_BYTES="2147483648"    # 2GB
L2_CACHE_SHARD_COUNT="128"            # CPU-adaptive, high concurrency

# ============================================================
# Replication - Production
# ============================================================

# Production replication (high durability)
REPLICATION_MIN_IN_SYNC_REPLICAS="3"  # Require 3 replicas before ack
REPLICATION_ACK_TIMEOUT_MS="5000"
REPLICATION_MAX_LAG="500"  # Stricter lag tolerance

# ============================================================
# ETL/WASM - Production
# ============================================================

ETL_ENABLED="true"
ETL_MEMORY_LIMIT_BYTES="67108864"  # 64MB per execution
ETL_EXECUTION_TIMEOUT_MS="5000"
ETL_MAX_CONCURRENT_EXECUTIONS="200"  # Higher concurrency

# ============================================================
# Security - Production
# ============================================================

# FULL security stack (REQUIRED for production)
TLS_ENABLED="true"
MTLS_ENABLED="true"

# Production secrets in Secret Manager
TLS_CERT_SECRET_NAME="rustmq-production-tls-cert"
TLS_KEY_SECRET_NAME="rustmq-production-tls-key"
TLS_CA_SECRET_NAME="rustmq-production-ca-cert"
GCS_CREDENTIALS_SECRET_NAME="rustmq-production-gcs-credentials"

# ACL (547ns fast lookups from Phase 1)
ENABLE_ACL="true"
ACL_CACHE_SIZE="50000"  # Larger cache for production

# Pod Security Standards (enforce restricted)
POD_SECURITY_STANDARD="restricted"

# Network policies (REQUIRED)
ENABLE_NETWORK_POLICIES="true"

# Audit logging
ENABLE_AUDIT_LOGGING="true"
AUDIT_LOG_PATH="/var/log/rustmq/audit.log"

# ============================================================
# Monitoring & Observability - Production
# ============================================================

# Full monitoring stack
ENABLE_MONITORING="true"
ENABLE_PROMETHEUS="true"
ENABLE_GRAFANA="true"
ENABLE_ALERTMANAGER="true"

# Production logging (structured JSON)
ENABLE_LOGGING="true"
LOG_LEVEL="info"  # Production: info (not debug)
LOG_FORMAT="json"

# Distributed tracing (REQUIRED for production debugging)
ENABLE_TRACING="true"
TRACING_SAMPLE_RATE="0.1"  # 10% sampling

# Metrics and alerting
METRICS_INTERVAL_SECONDS="30"  # More frequent in prod
ENABLE_CUSTOM_METRICS="true"
ENABLE_PAGERDUTY_INTEGRATION="true"

# ============================================================
# Networking - Production
# ============================================================

# Production VPC (isolated, private)
VPC_NAME="rustmq-production-vpc"
SUBNET_NAME="rustmq-production-subnet"
SUBNET_CIDR="10.0.0.0/16"  # Large address space

# Production load balancer
ENABLE_LOAD_BALANCER="true"
LOAD_BALANCER_TYPE="INTERNAL"  # Internal for security
# Set to EXTERNAL if client access from internet is required

# Network policies (strict)
ENABLE_NETWORK_POLICIES="true"
NETWORK_POLICY_MODE="strict"

# Private GKE cluster (no public endpoint)
ENABLE_PRIVATE_CLUSTER="true"
ENABLE_PRIVATE_NODES="true"

# ============================================================
# High Availability - Production
# ============================================================

# Pod Disruption Budgets (REQUIRED for HA)
ENABLE_PDB="true"
CONTROLLER_MIN_AVAILABLE="3"  # For 5 replicas (tolerate 2 failures)
BROKER_MIN_AVAILABLE="3"      # Maintain quorum during updates

# Pod anti-affinity (REQUIRED - spread across zones)
ENABLE_POD_ANTI_AFFINITY="true"
ENABLE_ZONE_ANTI_AFFINITY="true"

# Topology spread constraints
ENABLE_TOPOLOGY_SPREAD="true"
TOPOLOGY_SPREAD_MAX_SKEW="1"

# ============================================================
# Scaling - Production
# ============================================================

# Horizontal Pod Autoscaler
ENABLE_HPA="true"
BROKER_HPA_TARGET_CPU="60"     # Conservative (scale earlier)
BROKER_HPA_TARGET_MEMORY="70"

# Vertical Pod Autoscaler (recommendations)
ENABLE_VPA="true"
VPA_MODE="Recreate"  # or "Auto" for automatic

# Cluster Autoscaler
ENABLE_CLUSTER_AUTOSCALER="true"
CLUSTER_AUTOSCALER_PROFILE="optimize-utilization"

# Scaling velocity
MAX_CONCURRENT_BROKER_ADDITIONS="5"  # Higher than dev
MAX_CONCURRENT_BROKER_DECOMMISSIONS="2"
REBALANCE_TIMEOUT_MS="600000"  # 10 minutes (longer for safety)

# ============================================================
# Operations - Production
# ============================================================

# Runtime config updates (careful in prod!)
ALLOW_RUNTIME_CONFIG_UPDATES="false"  # Require deployment for changes

# Graceful shutdown (longer timeout for clean shutdown)
GRACEFUL_SHUTDOWN_TIMEOUT_MS="60000"  # 60 seconds

# Health checks (production SLOs)
HEALTH_CHECK_TIMEOUT_MS="10000"
HEALTH_CHECK_INTERVAL_SECONDS="30"
HEALTH_CHECK_FAILURE_THRESHOLD="3"

# Upgrade strategy (rolling updates with canary)
UPGRADE_STRATEGY="RollingUpdate"
UPGRADE_MAX_SURGE="1"
UPGRADE_MAX_UNAVAILABLE="0"  # Zero downtime

# ============================================================
# Cost Optimization - Production
# ============================================================

# NO auto-shutdown in production (24/7 operation)
ENABLE_AUTO_SHUTDOWN="false"

# NO preemptible nodes in production (reliability over cost)
ENABLE_PREEMPTIBLE_NODES="false"
PREEMPTIBLE_NODE_PERCENTAGE="0"

# Committed use discounts (reserve capacity)
ENABLE_COMMITTED_USE_DISCOUNTS="true"
COMMITTED_USE_YEARS="1"  # 1-year or 3-year commitment

# Resource quotas (prevent runaway costs)
ENABLE_RESOURCE_QUOTAS="true"
MAX_CPU_QUOTA="500"      # 500 cores max
MAX_MEMORY_QUOTA="2000Gi"  # 2TB max

# ============================================================
# Backup & Disaster Recovery - Production
# ============================================================

# Automated backups
ENABLE_AUTOMATED_BACKUPS="true"
BACKUP_SCHEDULE="0 2 * * *"  # Daily at 2am
BACKUP_RETENTION_DAYS="30"

# Snapshot configuration
ENABLE_VOLUME_SNAPSHOTS="true"
SNAPSHOT_SCHEDULE="0 */6 * * *"  # Every 6 hours
SNAPSHOT_RETENTION_COUNT="7"

# Disaster recovery
ENABLE_DISASTER_RECOVERY="true"
DR_REGION="${GCP_SECONDARY_REGION}"
DR_RTO_HOURS="4"   # Recovery Time Objective: 4 hours
DR_RPO_HOURS="1"   # Recovery Point Objective: 1 hour

# ============================================================
# Compliance & Governance - Production
# ============================================================

# Compliance requirements
ENABLE_COMPLIANCE_MONITORING="true"
COMPLIANCE_FRAMEWORKS="SOC2,GDPR,HIPAA"

# Data retention
DATA_RETENTION_DAYS="365"  # 1 year
LOG_RETENTION_DAYS="90"    # 90 days

# Encryption
ENABLE_ENCRYPTION_AT_REST="true"
ENABLE_ENCRYPTION_IN_TRANSIT="true"
KMS_KEY_ID="projects/${GCP_PROJECT_ID}/locations/${GCP_REGION}/keyRings/rustmq/cryptoKeys/data-encryption"

# ============================================================
# Admin - Production
# ============================================================

# Production admin server (for operational tasks)
ADMIN_SERVER_REPLICAS="2"  # HA for admin
ADMIN_SERVER_CPU="1000m"
ADMIN_SERVER_MEMORY="2Gi"

# Admin security
ADMIN_ENABLE_AUTHENTICATION="true"
ADMIN_ENABLE_RBAC="true"

# ============================================================
# Feature Flags - Production
# ============================================================

# NO experimental features in production
ENABLE_EXPERIMENTAL_FEATURES="false"

# NO debug mode in production
ENABLE_DEBUG_MODE="false"

# Production feature gates
ENABLE_FEATURE_GATES="true"
FEATURE_GATES="PrometheusMetrics=true,OpenTelemetry=true,AdvancedACL=true"

# ============================================================
# Production-Specific Settings
# ============================================================

# Docker image tag (use semver tags in production)
IMAGE_TAG="v1.0.0"  # Semantic versioning

# Multi-platform (support both AMD64 and ARM64 for cost optimization)
BUILD_PLATFORMS="linux/amd64,linux/arm64"

# Validation (STRICT in production)
SKIP_VALIDATION="false"  # NEVER skip validation in prod

# Dry run (NEVER in production - use staging first)
DRY_RUN="false"

# Verbose logging (moderate in prod)
VERBOSE="false"

# ============================================================
# SLO/SLA Targets - Production
# ============================================================

# Service Level Objectives
SLO_AVAILABILITY="99.95"  # 99.95% uptime
SLO_LATENCY_P50="10"      # 10ms p50
SLO_LATENCY_P95="50"      # 50ms p95
SLO_LATENCY_P99="100"     # 100ms p99
SLO_ERROR_RATE="0.01"     # 0.01% error rate

# Error budget
ERROR_BUDGET_POLICY="burn-rate"
ERROR_BUDGET_BURN_RATE_THRESHOLD="2.0"

# ============================================================
# Notes for Production
# ============================================================

# This production environment is configured for:
# 1. Maximum reliability (99.95% uptime SLO)
# 2. High availability (multi-zone, 5 controllers, min 5 brokers)
# 3. Enterprise security (mTLS, Binary Auth, Workload Identity, Network Policies)
# 4. Production scale (up to 50 brokers, 10k connections/broker)
# 5. Full observability (Prometheus, Grafana, Tracing, Alerting)
# 6. Disaster recovery (automated backups, multi-region)
# 7. Compliance (SOC2, GDPR, HIPAA ready)
#
# CRITICAL REQUIREMENTS:
# - CONTROLLER_REPLICAS must be odd (5 recommended for prod)
# - Binary Authorization REQUIRED
# - Workload Identity REQUIRED
# - Network Policies REQUIRED
# - TLS/mTLS REQUIRED
# - Monitoring REQUIRED
# - Backups REQUIRED
#
# Cost estimate: $500-1000/month depending on load
# (50 brokers × n2-standard-8 + controllers + storage + networking)
#
# BEFORE DEPLOYING TO PRODUCTION:
# 1. Test in staging environment first
# 2. Run load tests to validate capacity
# 3. Verify disaster recovery procedures
# 4. Complete security audit
# 5. Review and approve with team
# 6. Plan rollback strategy
